{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 166, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Trinos/Learning/PointofTwo/Po2/app/api/analyze/route.ts"],"sourcesContent":["import { GoogleGenAI, Type } from \"@google/genai\";\nimport type { Suggestion } from '@/lib/types/proofreader';\nimport { NextRequest, NextResponse } from 'next/server';\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Check for GEMINI_API_KEY (server-side) or NEXT_PUBLIC_API_KEY (for backward compatibility)\n    const apiKey = process.env.GEMINI_API_KEY || process.env.NEXT_PUBLIC_API_KEY;\n    \n    if (!apiKey) {\n      return NextResponse.json(\n        { error: \"API_KEY environment variable not set. Please set GEMINI_API_KEY or NEXT_PUBLIC_API_KEY.\" },\n        { status: 500 }\n      );\n    }\n\n    const { pdfTextByPage } = await request.json();\n\n    if (!pdfTextByPage || typeof pdfTextByPage !== 'string') {\n      return NextResponse.json(\n        { error: \"Invalid request: pdfTextByPage is required.\" },\n        { status: 400 }\n      );\n    }\n\n    const ai = new GoogleGenAI({ apiKey });\n\n    const prompt = `\n      You are an expert proofreader. Analyze the following text extracted from a PDF document. The text for each page is separated by '--- PAGE [number] ---'.\n      Identify any language errors, including grammatical mistakes, spelling errors, awkward phrasing, and punctuation issues.\n      For each error you find, provide the original problematic text snippet, a corrected version, a brief explanation for the change, and the page number where it was found.\n      Return your findings as a JSON array. Do not include suggestions if the text is perfect. If there are no errors, return an empty array.\n\n      Here is the text:\n      ${pdfTextByPage}\n    `;\n\n    const responseSchema = {\n      type: Type.ARRAY,\n      items: {\n        type: Type.OBJECT,\n        properties: {\n          page: {\n            type: Type.INTEGER,\n            description: \"The page number where the error was found.\",\n          },\n          original: {\n            type: Type.STRING,\n            description: \"The original text snippet with the error.\",\n          },\n          suggestion: {\n            type: Type.STRING,\n            description: \"The suggested correction for the text.\",\n          },\n          explanation: {\n            type: Type.STRING,\n            description: \"A brief explanation of why the correction is needed.\",\n          },\n        },\n        required: [\"page\", \"original\", \"suggestion\", \"explanation\"],\n      },\n    };\n\n    const response = await ai.models.generateContent({\n      model: 'gemini-2.5-flash',\n      contents: prompt,\n      config: {\n        responseMimeType: \"application/json\",\n        responseSchema: responseSchema,\n      },\n    });\n\n    // Check if response has text property\n    if (!response || typeof response.text !== 'string') {\n      console.error(\"Invalid response structure:\", response);\n      throw new Error(`Invalid response from AI: response.text is not available. Response structure: ${JSON.stringify(response)}`);\n    }\n\n    const jsonText = response.text.trim();\n    \n    if (!jsonText) {\n      throw new Error(`Empty response from AI.`);\n    }\n\n    let suggestions: Suggestion[];\n    \n    try {\n      suggestions = JSON.parse(jsonText);\n    } catch (parseError) {\n      console.error(\"Failed to parse Gemini response as JSON:\", parseError);\n      console.error(\"Response text:\", jsonText);\n      throw new Error(`Failed to parse AI response. The response may not be valid JSON.`);\n    }\n    \n    // Validate that suggestions is an array\n    if (!Array.isArray(suggestions)) {\n      throw new Error(`Invalid response format: expected an array of suggestions, got ${typeof suggestions}`);\n    }\n    \n    return NextResponse.json({ suggestions });\n  } catch (error) {\n    console.error(\"Error analyzing content with Gemini:\", error);\n    \n    // Extract error information from various error formats\n    let errorMessage = \"Failed to get suggestions from the AI. Please check the console for details.\";\n    let statusCode = 500;\n    \n    if (error instanceof Error) {\n      errorMessage = error.message || errorMessage;\n      \n      // Check if error has additional properties (common in API errors)\n      const errorAny = error as any;\n      if (errorAny.status || errorAny.code) {\n        statusCode = errorAny.status || errorAny.code || statusCode;\n      }\n      \n      // Handle nested error structures from Gemini API\n      if (errorAny.error) {\n        const nestedError = errorAny.error;\n        if (typeof nestedError === 'object') {\n          if (nestedError.message) {\n            errorMessage = nestedError.message;\n          }\n          if (nestedError.code) {\n            statusCode = nestedError.code;\n          } else if (nestedError.status) {\n            // Map status strings to HTTP codes\n            const statusMap: Record<string, number> = {\n              'UNAVAILABLE': 503,\n              'RESOURCE_EXHAUSTED': 429,\n              'UNAUTHENTICATED': 401,\n              'PERMISSION_DENIED': 403,\n              'INVALID_ARGUMENT': 400,\n              'NOT_FOUND': 404,\n            };\n            statusCode = statusMap[nestedError.status] || statusCode;\n          }\n        }\n      }\n    } else if (typeof error === 'string') {\n      errorMessage = error;\n    } else if (error && typeof error === 'object') {\n      // Handle error objects directly\n      const errorObj = error as any;\n      if (errorObj.message) {\n        errorMessage = errorObj.message;\n      }\n      if (errorObj.error?.message) {\n        errorMessage = errorObj.error.message;\n      }\n      if (errorObj.error?.code) {\n        statusCode = errorObj.error.code;\n      } else if (errorObj.error?.status) {\n        const statusMap: Record<string, number> = {\n          'UNAVAILABLE': 503,\n          'RESOURCE_EXHAUSTED': 429,\n          'UNAUTHENTICATED': 401,\n          'PERMISSION_DENIED': 403,\n          'INVALID_ARGUMENT': 400,\n          'NOT_FOUND': 404,\n        };\n        statusCode = statusMap[errorObj.error.status] || statusCode;\n      }\n    }\n    \n    // Ensure status code is valid (between 400-599)\n    if (statusCode < 400 || statusCode >= 600) {\n      statusCode = 500;\n    }\n    \n    return NextResponse.json(\n      { error: { message: errorMessage, code: statusCode, status: statusCode === 503 ? 'UNAVAILABLE' : 'ERROR' } },\n      { status: statusCode }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}