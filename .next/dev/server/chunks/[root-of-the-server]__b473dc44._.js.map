{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Trinos/Learning/PointofTwo/Po2/app/api/pdf-to-docx/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { Document, Packer, Paragraph, TextRun, HeadingLevel } from 'docx';\n\nexport const runtime = 'nodejs';\n\n/**\n * Convert PDF to DOCX via backend\n * Extracts text from PDF and creates a DOCX document\n */\nexport async function POST(request: NextRequest) {\n  try {\n    // Validate request\n    const contentType = request.headers.get('content-type');\n    if (!contentType || !contentType.includes('multipart/form-data')) {\n      console.warn('Invalid content type:', contentType);\n    }\n\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n\n    if (!file) {\n      console.error('No file provided in form data');\n      return NextResponse.json(\n        { \n          error: 'No file provided',\n          message: 'Please ensure a file is included in the request'\n        },\n        { \n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    console.log('Received file:', {\n      name: file.name,\n      type: file.type,\n      size: file.size\n    });\n\n    // Check if it's a PDF\n    if (!file.name.toLowerCase().endsWith('.pdf') && file.type !== 'application/pdf') {\n      console.error('Invalid file type:', file.type, 'for file:', file.name);\n      return NextResponse.json(\n        { \n          error: 'File must be a PDF',\n          message: `Received file type: ${file.type || 'unknown'}`\n        },\n        { \n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    // Check file size (optional validation)\n    if (file.size === 0) {\n      console.error('Empty file provided');\n      return NextResponse.json(\n        { \n          error: 'Empty file provided',\n          message: 'The PDF file appears to be empty'\n        },\n        { \n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    console.log('Reading PDF file...');\n    let arrayBuffer;\n    try {\n      arrayBuffer = await file.arrayBuffer();\n      console.log('PDF file read, size:', arrayBuffer.byteLength, 'bytes');\n    } catch (readError) {\n      console.error('Failed to read PDF file:', readError);\n      const readErrorMessage = readError instanceof Error ? readError.message : 'Unknown error';\n      return NextResponse.json(\n        {\n          error: 'Failed to read PDF file',\n          message: readErrorMessage,\n          details: 'The PDF file could not be read from the request.'\n        },\n        {\n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    console.log('Parsing PDF document...');\n    let pdfData: { text: string; numpages: number } | null = null;\n    try {\n      // Use require for CommonJS module compatibility in Node.js runtime\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      const pdfParse = require('pdf-parse');\n\n      if (!pdfParse || typeof pdfParse !== 'function') {\n        throw new Error('pdf-parse function not found in module exports');\n      }\n\n      // Call pdf-parse directly with the buffer\n      const result = await pdfParse(Buffer.from(arrayBuffer));\n\n      pdfData = {\n        text: result.text || '',\n        numpages: result.numpages || 0,\n      };\n\n      console.log('PDF parsed successfully, pages:', pdfData.numpages);\n    } catch (parseError) {\n      console.error('Failed to parse PDF:', parseError);\n      const parseErrorMessage = parseError instanceof Error ? parseError.message : 'Unknown error';\n      return NextResponse.json(\n        {\n          error: 'Failed to parse PDF',\n          message: parseErrorMessage,\n          details: 'The PDF file could not be parsed. It may be corrupted or in an unsupported format.'\n        },\n        {\n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    if (!pdfData) {\n      return NextResponse.json(\n        {\n          error: 'Failed to parse PDF',\n          message: 'No data was extracted from the PDF document',\n          details: 'The PDF parser returned no data. The file may be empty or unsupported.'\n        },\n        {\n          status: 400,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    // Extract text and structure from PDF\n    console.log('Extracting text from PDF...');\n    const paragraphs: Paragraph[] = [];\n    \n    try {\n      // Split text into paragraphs (double newlines indicate paragraph breaks)\n      const textBlocks = pdfData.text.split(/\\n\\s*\\n/).filter(block => block.trim());\n      \n      textBlocks.forEach((textBlock) => {\n        const trimmedText = textBlock.trim();\n        if (!trimmedText) return;\n\n        // Simple heuristic: detect headings (short lines, typically at start)\n        const lines = trimmedText.split('\\n');\n        const firstLine = lines[0]?.trim() || '';\n        \n        let paragraphOptions: any = {\n          children: [new TextRun({ text: trimmedText })],\n        };\n\n        // Determine if it's a heading (short first line, typically less than 100 chars)\n        if (firstLine.length < 100 && lines.length === 1) {\n          // Check if it looks like a heading (all caps, or starts with number, etc.)\n          if (firstLine === firstLine.toUpperCase() || /^\\d+\\.?\\s/.test(firstLine)) {\n            paragraphOptions.heading = HeadingLevel.HEADING_2;\n          } else if (firstLine.length < 60) {\n            paragraphOptions.heading = HeadingLevel.HEADING_3;\n          }\n        }\n\n        paragraphs.push(new Paragraph(paragraphOptions));\n      });\n    } catch (extractionError) {\n      console.error('Error extracting text from PDF:', extractionError);\n      const extractionErrorMessage = extractionError instanceof Error ? extractionError.message : 'Unknown error';\n      return NextResponse.json(\n        {\n          error: 'Failed to extract text from PDF',\n          message: extractionErrorMessage,\n          details: 'An error occurred while extracting text from the PDF.'\n        },\n        {\n          status: 500,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    console.log('Text extraction complete. Paragraphs:', paragraphs.length);\n\n    // Create DOCX document\n    console.log('Creating DOCX document...');\n    let doc;\n    try {\n      doc = new Document({\n        sections: [\n          {\n            properties: {},\n            children: paragraphs.length > 0 ? paragraphs : [\n              new Paragraph({\n                children: [new TextRun({ text: 'No text content found in PDF.' })],\n              }),\n            ],\n          },\n        ],\n      });\n      console.log('DOCX document created successfully');\n    } catch (docError) {\n      console.error('Error creating DOCX document:', docError);\n      const docErrorMessage = docError instanceof Error ? docError.message : 'Unknown error';\n      return NextResponse.json(\n        {\n          error: 'Failed to create DOCX document',\n          message: docErrorMessage,\n          details: 'An error occurred while creating the DOCX document structure.'\n        },\n        {\n          status: 500,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    // Generate DOCX buffer\n    console.log('Generating DOCX buffer...');\n    let buffer;\n    try {\n      buffer = await Packer.toBuffer(doc);\n      console.log('DOCX buffer generated, size:', buffer.length, 'bytes');\n    } catch (bufferError) {\n      console.error('Error generating DOCX buffer:', bufferError);\n      const bufferErrorMessage = bufferError instanceof Error ? bufferError.message : 'Unknown error';\n      return NextResponse.json(\n        {\n          error: 'Failed to generate DOCX file',\n          message: bufferErrorMessage,\n          details: 'An error occurred while generating the DOCX file buffer.'\n        },\n        {\n          status: 500,\n          headers: {\n            'Content-Type': 'application/json',\n          }\n        }\n      );\n    }\n\n    // Return DOCX file\n    return new NextResponse(buffer, {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n        'Content-Disposition': `attachment; filename=\"${file.name.replace(/\\.pdf$/i, '.docx')}\"`,\n      },\n    });\n  } catch (error) {\n    console.error('PDF to DOCX conversion error:', error);\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    const errorStack = error instanceof Error ? error.stack : undefined;\n    const errorName = error instanceof Error ? error.name : 'Error';\n    \n    // Log full error details for debugging\n    console.error('Error name:', errorName);\n    console.error('Error message:', errorMessage);\n    if (errorStack) {\n      console.error('Error stack:', errorStack);\n    }\n    \n    // Ensure we always return a valid JSON error response\n    const errorResponse = {\n      error: 'Failed to convert PDF to DOCX',\n      message: errorMessage,\n      ...(process.env.NODE_ENV === 'development' && {\n        details: errorMessage,\n        name: errorName,\n        ...(errorStack ? { stack: errorStack } : {})\n      })\n    };\n    \n    console.error('Returning error response:', JSON.stringify(errorResponse, null, 2));\n    \n    return NextResponse.json(\n      errorResponse,\n      { \n        status: 500,\n        headers: {\n          'Content-Type': 'application/json',\n        }\n      }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}