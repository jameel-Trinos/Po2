{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/Trinos/Learning/PointofTwo/Po2/app/api/compliance/analyze/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport mammoth from 'mammoth';\n\n// Force Node.js runtime for mammoth compatibility\nexport const runtime = 'nodejs';\n\n// Mock compliance issues generator\nfunction generateMockCompliance(text: string) {\n  const suggestions = [];\n  \n  // FINRA compliance suggestions\n  const finraPatterns = [\n    {\n      pattern: /\\b(guaranteed|guarantee|guarantees)\\s+(returns?|profits?|income|gains?)\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'FINRA Rule 2210 prohibits guarantees of investment returns',\n      getReplacement: (match: string) => match.replace(/guaranteed?|guarantees?/gi, 'potential')\n    },\n    {\n      pattern: /\\b(promise|promises|assure|assures)\\s+(returns?|profits?|income|gains?)\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'FINRA Rule 2210 prohibits promises of specific investment returns',\n      getReplacement: (match: string) => match.replace(/promise|promises|assure|assures/gi, 'target')\n    },\n    {\n      pattern: /\\bhigh returns?\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'Claims of \"high returns\" may violate FINRA communications standards',\n      getReplacement: (match: string) => 'competitive returns'\n    },\n    {\n      pattern: /\\brisk[- ]free\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'No investment is truly risk-free. This violates FINRA Rule 2210',\n      getReplacement: (match: string) => 'lower-risk'\n    },\n    {\n      pattern: /\\b(best|top|#1|number one)\\s+(investment|fund|stock|opportunity)\\b/gi,\n      category: 'FINRA',\n      severity: 'warning',\n      explanation: 'Superlative claims require substantiation per FINRA Rule 2210',\n      getReplacement: (match: string) => match.replace(/best|top|#1|number one/gi, 'leading')\n    },\n    {\n      pattern: /\\bno risk\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'All investments carry some level of risk per FINRA requirements',\n      getReplacement: (match: string) => 'minimal risk'\n    },\n    {\n      pattern: /\\bsafe investment\\b/gi,\n      category: 'FINRA',\n      severity: 'warning',\n      explanation: 'The term \"safe\" may be misleading per FINRA standards',\n      getReplacement: (match: string) => 'conservative investment'\n    },\n    {\n      pattern: /\\b(can'?t|cannot|won'?t)\\s+(lose|fail)\\b/gi,\n      category: 'FINRA',\n      severity: 'critical',\n      explanation: 'Statements implying no possibility of loss violate FINRA Rule 2210',\n      getReplacement: (match: string) => 'historically resilient'\n    }\n  ];\n\n  // SEC compliance suggestions\n  const secPatterns = [\n    {\n      pattern: /\\binsider (information|knowledge|tip|trading)\\b/gi,\n      category: 'SEC',\n      severity: 'critical',\n      explanation: 'Reference to insider information may violate SEC Rule 10b-5',\n      getReplacement: (match: string) => 'publicly available information'\n    },\n    {\n      pattern: /\\bconfidential (deal|agreement|information|data)\\b/gi,\n      category: 'SEC',\n      severity: 'warning',\n      explanation: 'Disclosure of confidential information may violate SEC regulations',\n      getReplacement: (match: string) => match.replace(/confidential/gi, 'publicly disclosed')\n    },\n    {\n      pattern: /\\b(manipulation|manipulate|manipulating)\\s+(price|market|stock)\\b/gi,\n      category: 'SEC',\n      severity: 'critical',\n      explanation: 'References to market manipulation should be avoided or clarified',\n      getReplacement: (match: string) => 'market activity'\n    },\n    {\n      pattern: /\\bunregistered (security|securities|offering)\\b/gi,\n      category: 'SEC',\n      severity: 'critical',\n      explanation: 'Unregistered securities must comply with SEC regulations',\n      getReplacement: (match: string) => 'private placement'\n    }\n  ];\n\n  // Grammar suggestions\n  const grammarPatterns = [\n    {\n      pattern: /\\btheir\\s+are\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: \"their\" should be \"there\"',\n      getReplacement: (match: string) => 'there are'\n    },\n    {\n      pattern: /\\btheir\\s+(is|was|were)\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: \"their\" should be \"there\"',\n      getReplacement: (match: string) => match.replace(/their/gi, 'there')\n    },\n    {\n      pattern: /\\byour\\s+welcome\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: \"your\" should be \"you\\'re\" (you are)',\n      getReplacement: (match: string) => \"you're welcome\"\n    },\n    {\n      pattern: /\\bits\\s+(a|the|an)\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: \"its\" should be \"it\\'s\" (it is)',\n      getReplacement: (match: string) => match.replace(/its/gi, \"it's\")\n    },\n    {\n      pattern: /\\beffect\\s+(change|growth|improvement)\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Should use \"affect\" (verb) not \"effect\" (noun) in this context',\n      getReplacement: (match: string) => match.replace(/effect/gi, 'affect')\n    },\n    {\n      pattern: /\\balot\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect spelling: should be \"a lot\" (two words)',\n      getReplacement: (match: string) => 'a lot'\n    },\n    {\n      pattern: /\\bcould\\s+of\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: should be \"could have\" or \"could\\'ve\"',\n      getReplacement: (match: string) => 'could have'\n    },\n    {\n      pattern: /\\bshould\\s+of\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: should be \"should have\" or \"should\\'ve\"',\n      getReplacement: (match: string) => 'should have'\n    },\n    {\n      pattern: /\\bwould\\s+of\\b/gi,\n      category: 'Grammar',\n      severity: 'info',\n      explanation: 'Incorrect usage: should be \"would have\" or \"would\\'ve\"',\n      getReplacement: (match: string) => 'would have'\n    }\n  ];\n\n  const allPatterns = [...finraPatterns, ...secPatterns, ...grammarPatterns];\n\n  // Find matches in text\n  allPatterns.forEach((pattern) => {\n    const matches = text.matchAll(pattern.pattern);\n    for (const match of matches) {\n      if (match[0]) {\n        // Get the suggested replacement text\n        const suggestedText = pattern.getReplacement(match[0]);\n        \n        suggestions.push({\n          category: pattern.category,\n          severity: pattern.severity,\n          originalText: match[0],\n          suggestedText: suggestedText,\n          explanation: pattern.explanation,\n          page: 1,\n        });\n      }\n    }\n  });\n\n  return suggestions;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    console.log('Starting document analysis...');\n    const formData = await request.formData();\n    const file = formData.get('file') as File;\n\n    if (!file) {\n      console.log('No file provided');\n      return NextResponse.json(\n        { error: 'No file provided' },\n        { status: 400 }\n      );\n    }\n\n    console.log('File received:', file.name, 'Size:', file.size, 'Type:', file.type);\n\n    // Validate file type\n    const fileName = file.name.toLowerCase();\n    if (!fileName.endsWith('.docx')) {\n      console.log('Invalid file type:', fileName);\n      return NextResponse.json(\n        { error: 'Only .docx files are supported' },\n        { status: 400 }\n      );\n    }\n\n    // Extract text from DOCX\n    console.log('Converting file to array buffer...');\n    const arrayBuffer = await file.arrayBuffer();\n    console.log('Array buffer size:', arrayBuffer.byteLength);\n    \n    // Convert ArrayBuffer to Buffer for mammoth\n    console.log('Converting to Buffer...');\n    const buffer = Buffer.from(arrayBuffer);\n    console.log('Buffer size:', buffer.length);\n    \n    console.log('Extracting raw text with mammoth...');\n    const result = await mammoth.extractRawText({ buffer });\n    const extractedText = result.value;\n    console.log('Extracted text length:', extractedText.length);\n\n    // Also convert to HTML for editor\n    console.log('Converting to HTML with mammoth...');\n    const htmlResult = await mammoth.convertToHtml({ buffer });\n    const htmlContent = htmlResult.value;\n    console.log('HTML content length:', htmlContent.length);\n\n    // Generate mock compliance suggestions\n    const suggestions = generateMockCompliance(extractedText);\n\n    // Mock: Deduct balance for API usage (0.10 credits per analysis)\n    const costPerAnalysis = 0.10;\n\n    return NextResponse.json({\n      success: true,\n      documentId: Date.now().toString(), // Mock document ID\n      htmlContent,\n      extractedText,\n      suggestions,\n      cost: costPerAnalysis,\n      message: `Analysis complete. Found ${suggestions.length} suggestions.`,\n    });\n  } catch (error) {\n    console.error('Error analyzing document:', error);\n    console.error('Error details:', {\n      name: error instanceof Error ? error.name : 'Unknown',\n      message: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : 'No stack trace'\n    });\n    return NextResponse.json(\n      { \n        error: 'Failed to analyze document',\n        details: error instanceof Error ? error.message : String(error)\n      },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}